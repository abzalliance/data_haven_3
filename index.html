<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Moose: Acorn Adventure</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: #222;
      font-family: 'Poppins', 'Arial', sans-serif;
      user-select: none;
    }
    #bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
      top: 0; left: 0;
      filter: blur(2px) brightness(0.7);
      pointer-events: none;
    }
    #gameCanvas {
      position: fixed;
      left: 0; top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      background: transparent;
      display: block;
    }
    #scoreBox {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      background: rgba(255,255,255,0.85);
      color: #222;
      border-radius: 22px;
      padding: 14px 38px;
      font-size: 2rem;
      font-weight: bold;
      box-shadow: 0 2px 32px #0005;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #scoreBox img { width: 38px; height: 38px; }
    #highscoreBox {
      position: fixed;
      top: 28px;
      right: 38px;
      z-index: 2;
      color: #fff;
      font-size: 1rem;
      background: rgba(0,0,0,0.4);
      border-radius: 14px;
      padding: 7px 16px;
      box-shadow: 0 2px 8px #0005;
    }
    #overlay {
      position: fixed;
      z-index: 10;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 28px;
    }
    #overlay::before {
      content: '';
      position: absolute;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.62);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    #gameTitle {
      color: #fff;
      font-size: 3.2rem;
      font-weight: 900;
      text-shadow: 0 4px 32px #000b, 0 2px 0 #fff3;
      letter-spacing: 3px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: center;
      animation: bounce 1s infinite alternate;
      user-select: none;
    }
    #gameTitle .emoji {
      font-size: 2.5rem;
      filter: drop-shadow(0 2px 8px #0008);
    }
    #nicknameBlock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
    }
    #nicknameInputMain {
      font-size: 1.25rem;
      padding: 12px 20px;
      border-radius: 12px;
      border: 1.5px solid #bbb;
      outline: none;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 2px 12px #0002;
      background: rgba(255,255,255,0.92);
      transition: border .18s, box-shadow .18s;
    }
    #nicknameInputMain:focus {
      border: 1.5px solid #2a7b3f;
      box-shadow: 0 2px 18px #2a7b3f33;
    }
    #nicknameCurrent {
      font-size: 1.05rem;
      color: #2a7b3f;
      margin-top: -2px;
      margin-bottom: 2px;
    }
    #startBtn {
      padding: 16px 48px;
      font-size: 1.35rem;
      font-weight: bold;
      border: none;
      border-radius: 18px;
      background: linear-gradient(90deg, #ffe55a 0%, gold 100%);
      color: #333;
      cursor: pointer;
      box-shadow: 0 4px 24px #0007;
      transition: background .18s, transform .12s;
      margin-top: 18px;
      margin-bottom: 10px;
    }
    #startBtn:hover { background: #fff36a; transform: scale(1.045); }
    #gameDesc {
      color: #fff;
      font-size: 1.25rem;
      text-align: center;
      margin-top: 10px;
      line-height: 1.6;
      max-width: 420px;
      text-shadow: 0 2px 12px #000a;
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 12px 18px 10px 18px;
      user-select: none;
    }
    @keyframes bounce { to { transform: translateY(-12px); } }
    #overlayText {
      color: #fff;
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 6px;
      line-height: 1.5;
    }
    #nicknameBlock label {
      color: #fff;
      font-weight: bold;
      font-size: 1.15rem;
      margin-bottom: 2px;
    }
  </style>
</head>
<body tabindex="0" style="margin:0;padding:0;">
  <video id="startBgVideo" src="background.mp4" autoplay loop muted playsinline style="position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;display:block;"></video>
  <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100vw;height:100vh;">
    <canvas id="gameCanvas"></canvas>
    <div id="scoreBox" style="display:none;align-items:center;gap:18px;">
      <span id="statTime">00:00</span>
      <span style="margin: 0 12px;">|</span>
      <img id="acornIcon" src="acorns.webp" alt="acorn" style="width:32px;height:32px;vertical-align:middle;">
      <span id="score">0</span>
      <span style="margin: 0 12px;">|</span>
      <span>Record: <span id="highscore">0</span></span>
    </div>
    <div id="overlay">
      <div id="gameTitle"><span class="emoji">ðŸ¦Œ</span> Flappy Moose: Stump Dodge <span class="emoji">ðŸŒ²</span></div>
      <div id="gameOverBlock" style="display:none;text-align:center;color:#fff;margin-bottom:10px;">
        <div id="gameOverText" style="font-size:1.5rem;font-weight:bold;"></div>
        <div id="gameOverScore" style="font-size:1.2rem;margin:8px 0 0 0;"></div>
      </div>
      <label for="nicknameInputMain" style="font-weight:bold;font-size:1.1rem;margin-top:18px;color:#fff;">Nickname:</label>
      <input id="nicknameInputMain" type="text" maxlength="16" placeholder="Enter your nickname" style="font-size:1.1rem;padding:10px 18px;border-radius:10px;border:1.5px solid #bbb;outline:none;width:100%;max-width:260px;margin-top:6px;">
      <div id="nicknameCurrent" style="font-size:1.05rem;color:#2a7b3f;margin-bottom:2px;">Current: Player</div>
      <button id="startBtn">Start</button>
      <div id="gameDesc">
        Jump on stumps, collect acorns, avoid falling!<br>
        <b>How long can you survive?</b><br>
        <span style="font-size:1.05rem;color:#ffe55a;">The speed increases every second!</span>
      </div>
    </div>
  </div>
  <script>
    // Game settings
    const MOOSE_W = 90, MOOSE_H = 90;
    const GRAVITY = 0.09;
    const FLAP = -7;
    const PIPE_W = 60, PIPE_GAP = 380;
    const PIPE_SPEED = 2.2;
    let gameStarted = false, gameOver = false;
    let score = 0;
    let highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
    let nickname = '';
    let moose = null, pipes = [], acorns = [], animId = 0, lastPipeTime = 0;
    let W=window.innerWidth, H=window.innerHeight;
    let lastAcornTime = 0;
    let platformOffset = 0;
    const RUN_SPEED = 3.2;
    const PLATFORM_HEIGHT = 180;
    let mooseStep = 0;
    const PLATFORM_TOP_OFFSET = 70
    let gameStartTime = 0;

    // Platform system
    let platforms = [];
    const PLATFORM_MIN_Y = 120;
    const PLATFORM_MAX_Y = 320;
    let platformWidth = 400;
    let platformGap = 200;
    const PLATFORM_WIDTH_START = 400;
    const PLATFORM_WIDTH_MIN = 180;
    const PLATFORM_GAP_START = 200;
    const PLATFORM_GAP_MAX = 420;

    // Load images
    const mooseImg = new Image();
    mooseImg.src = "moose.webp";
    const mooseLeftImg = new Image();
    mooseLeftImg.src = "moose_left.webp";
    const acornImg = new Image();
    acornImg.src = "acorns.webp";
    const platformImg = new Image();
    platformImg.src = "platform.webp";
    const bgImg = new Image();
    bgImg.src = "background.webp";
    const parallaxBgImg = new Image();
    parallaxBgImg.src = "background.webp";

    // DOM elements
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreBox = document.getElementById('scoreBox');
    const scoreSpan = document.getElementById('score');
    const highscoreBox = document.getElementById('highscoreBox');
    const highscoreSpan = document.getElementById('highscore');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const overlayText = document.getElementById('overlayText');
    const nicknameInput = document.getElementById('nicknameInput');
    const startBgVideo = document.getElementById('startBgVideo');
    const smallInstruction = document.getElementById('smallInstruction');
    
    function resize() {
      W = window.innerWidth; H = window.innerHeight;
      canvas.width = W; canvas.height = H;
    }
    window.addEventListener('resize', resize);
    resize();

    // Game reset
    function resetGame() {
      moose = {
        x: W*0.5 - MOOSE_W/2,
        y: 0,
        vy: 0,
        vx: 0,
        ax: 0,
        alive: true,
        onPlatform: true,
        justJumped: false
      };
      acorns = [];
      platformOffset = 0;
      mooseStep = 0;
      platforms = [];
      platformWidth = PLATFORM_WIDTH_START;
      platformGap = PLATFORM_GAP_START;
      
      let py = H - PLATFORM_HEIGHT - 40;
      for (let i = 0; py > -platformGap * 3; i++) {
        let px = W*0.5 - platformWidth/2 + (Math.random()-0.5)*W*0.25;
        platforms.push({x: px, y: py, width: platformWidth});
        py -= platformGap;
      }
      let lowest = platforms[0];
      moose.y = lowest.y - MOOSE_H + 80;
      score = 0;
      gameOver = false;
      scoreBox.style.display = '';
      scoreSpan.textContent = score;
      highscoreSpan.textContent = highscore;
    }

    function spawnPlatform() {
      const last = platforms[platforms.length-1];
      let py = last.y - platformGap;
      let px = W*0.5 - platformWidth/2 + (Math.random()-0.5)*W*0.4;
      let w = Math.max(PLATFORM_WIDTH_MIN, platformWidth * (0.6 + Math.random()*0.4));
      platforms.push({
        x: px, 
        y: py, 
        width: w,
        timeOnPlatform: 0,
        isShaking: false,
        willDestroy: false
      });
    }

    // Acorn spawning
    function spawnAcorn() {
      let candidates = platforms.filter(p => p.y < -50 && p.y > -400);
      if (candidates.length === 0) return;
      let p = candidates[Math.floor(Math.random()*candidates.length)];
      
      // Check if platform already has acorns - limit to 1-2 per platform
      let existingAcorns = acorns.filter(a => 
        !a.falling && !a.collected && 
        a.x >= p.x && a.x <= p.x + (p.width || platformWidth) &&
        Math.abs(a.y - (p.y - 60)) < 50
      );
      
      if (existingAcorns.length >= 2) {
        console.log('Platform already has', existingAcorns.length, 'acorns - skipping spawn');
        return;
      }
      
      // Only normal and gold acorns on platforms
      let acornType = Math.random();
      let type, points, filter, size;
      
      if (acornType < 0.3) {
        // Gold acorns (30% chance on platforms)
        type = 'gold';
        points = 3;
        filter = 'brightness(1.3) saturate(2) hue-rotate(30deg) contrast(1.2)';
        size = 70;
      } else {
        // Normal acorns (70% chance)
        type = 'normal';
        points = 1;
        filter = 'none';
        size = 60;
      }
      
      let x = p.x + 60 + Math.random()*((p.width || platformWidth)-120);
      acorns.push({
        x: x,
        y: p.y - 60,
        w: size,
        h: size,
        type: type,
        points: points,
        filter: filter,
        collected: false,
        sparkle: type === 'gold' ? 0 : null,
        falling: false
      });
      
      console.log('Created', type, 'acorn at:', x, p.y - 60, 'Platform acorns now:', existingAcorns.length + 1);
    }

    function spawnAcornCluster() {
      let candidates = platforms.filter(p => p.y < -100 && p.y > -350);
      if (candidates.length === 0) return;
      let p = candidates[Math.floor(Math.random()*candidates.length)];
      
      // Check existing acorns on this platform
      let existingAcorns = acorns.filter(a => 
        !a.falling && !a.collected && 
        a.x >= p.x && a.x <= p.x + (p.width || platformWidth) &&
        Math.abs(a.y - (p.y - 60)) < 50
      );
      
      // Only spawn if platform has less than 2 acorns
      let maxNewAcorns = Math.max(0, 2 - existingAcorns.length);
      if (maxNewAcorns === 0) {
        console.log('Platform full - no cluster spawn');
        return;
      }
      
      // Spawn 1 acorn maximum to respect limit
      let numAcorns = Math.min(1, maxNewAcorns);
      for (let i = 0; i < numAcorns; i++) {
        let x = p.x + 80 + i * 100 + Math.random() * 50;
        if (x > p.x + (p.width || platformWidth) - 80) break;
        
        // Only normal and gold acorns on platforms
        let acornType = Math.random();
        let type, points, filter, size;
        
        if (acornType < 0.25) {
          // Gold acorns (25% in clusters)
          type = 'gold';
          points = 3;
          filter = 'brightness(1.3) saturate(2) hue-rotate(30deg) contrast(1.2)';
          size = 70;
        } else {
          // Normal acorns (75%)
          type = 'normal';
          points = 1;
          filter = 'none';
          size = 60;
        }
        
        acorns.push({
          x: x,
          y: p.y - 60,
          w: size,
          h: size,
          type: type,
          points: points,
          filter: filter,
          collected: false,
          sparkle: type === 'gold' ? Math.random() * Math.PI * 2 : null,
          falling: false
        });
      }
      console.log('Created acorn cluster with', numAcorns, 'acorns. Platform total:', existingAcorns.length + numAcorns);
    }

    // Falling death acorns system
    function spawnFallingDeathAcorn() {
      let x = Math.random() * (W - 60);
      acorns.push({
        x: x,
        y: -50, // Start closer to visible area
        w: 60,  // Make them slightly bigger
        h: 60,
        type: 'death',
        points: -2,
        filter: 'brightness(0.3) saturate(0) contrast(1.5)', // Make them dark gray instead of black
        collected: false,
        sparkle: null,
        falling: true,
        fallSpeed: 4 + Math.random() * 2 // Make them fall faster
      });
      console.log('ðŸ–¤ SPAWNED FALLING DEATH ACORN at x:', x, 'y: -50, Total acorns:', acorns.length);
    }

    // Draw functions
    function drawBg() {
      let t = (Date.now() - gameStartTime) / 1000;
      let parallaxX = -((t*0.5)%1) * W;
      ctx.globalAlpha = 0.7;
      ctx.drawImage(parallaxBgImg, parallaxX, 0, W, H);
      ctx.drawImage(parallaxBgImg, parallaxX+W, 0, W, H);
      ctx.globalAlpha = 1;
      ctx.drawImage(bgImg, 0, 0, W, H);
      
      for (let p of platforms) {
        ctx.save();
        
        let offsetX = 0, offsetY = 0;
        if (p.isShaking) {
          offsetX = (Math.random() - 0.5) * 4;
          offsetY = (Math.random() - 0.5) * 2;
        }
        
        ctx.drawImage(platformImg, p.x + offsetX, p.y + offsetY, p.width || platformWidth, PLATFORM_HEIGHT);
        
        if (p.willDestroy) {
          ctx.fillStyle = 'rgba(255, 0, 0, 0.6)';
          ctx.fillRect(p.x, p.y - 30, p.width || platformWidth, 20);
          ctx.fillStyle = '#fff';
          ctx.font = '14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('PLATFORM DESTROYING!', p.x + (p.width || platformWidth)/2, p.y - 16);
        }
        
        ctx.restore();
      }
      
      let dayPhase = 0.5 + 0.5 * Math.sin(t/22);
      let r = Math.round(60 + 40*dayPhase);
      let g = Math.round(120 + 60*dayPhase);
      let b = Math.round(200 + 40*dayPhase);
      ctx.fillStyle = `rgba(${r},${g},${b},0.22)`;
      ctx.fillRect(0,0,W,H);
    }

    function drawMoose() {
      ctx.save();
      ctx.translate(moose.x + MOOSE_W/2, moose.y + MOOSE_H/2);
      let targetRotation = Math.max(-0.5, Math.min(0.5, moose.vy/18));
      ctx.rotate(targetRotation);
      let img = mooseImg;
      if (moose.vx < -0.5) img = mooseLeftImg;
      ctx.drawImage(img, -MOOSE_W/2, -MOOSE_H/2, MOOSE_W, MOOSE_H);
      ctx.restore();
    }
    
    function drawAcorns() {
      for (let a of acorns) {
        if (!a.collected) {
          let t = Date.now() / 1000;
          let bounce = a.falling ? 0 : Math.sin(t * 3 + a.x * 0.01) * 3;
          
          ctx.save();
          
          if (a.type === 'gold') {
            a.sparkle += 0.12;
            let sparkleIntensity = (Math.sin(a.sparkle) + 1) / 2;
            let pulseIntensity = (Math.sin(a.sparkle * 0.5) + 1) / 2;
            
            ctx.shadowColor = '#FFD700';
            ctx.shadowBlur = 20 + sparkleIntensity * 15;
            
            ctx.beginPath();
            ctx.arc(a.x + a.w/2, a.y + bounce + a.h/2, a.w/2 + 8 + pulseIntensity * 5, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(255, 215, 0, ${0.3 + sparkleIntensity * 0.4})`;
            ctx.lineWidth = 3;
            ctx.stroke();
            
          } else if (a.type === 'death') {
            // Death acorn with enhanced visibility
            ctx.shadowColor = a.falling ? '#FF0000' : '#000000';
            ctx.shadowBlur = a.falling ? 15 : 10;
            
            // Add red warning border for death acorns
            ctx.beginPath();
            ctx.arc(a.x + a.w/2, a.y + bounce + a.h/2, a.w/2 + 5, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.7)';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Add dark aura for death acorns
            if (a.falling) {
              ctx.beginPath();
              ctx.arc(a.x + a.w/2, a.y + bounce + a.h/2, a.w/2 + 10, 0, Math.PI * 2);
              ctx.fillStyle = 'rgba(255, 0, 0, 0.15)';
              ctx.fill();
            }
          }
          
          ctx.filter = a.filter;
          ctx.drawImage(acornImg, a.x, a.y + bounce, a.w, a.h);
          ctx.filter = 'none';
          ctx.shadowBlur = 0;
          
          if (a.type === 'gold') {
            let sparkleIntensity = (Math.sin(a.sparkle) + 1) / 2;
            let sparkleSize = sparkleIntensity * 0.8;
            
            for (let i = 0; i < 3; i++) {
              let angle = a.sparkle + i * (Math.PI * 2 / 3);
              let sparkleX = a.x + a.w/2 + Math.cos(angle) * (a.w * 0.3);
              let sparkleY = a.y + bounce + a.h/2 + Math.sin(angle) * (a.h * 0.3);
              
              ctx.fillStyle = `rgba(255, 255, 255, ${sparkleSize})`;
              ctx.beginPath();
              ctx.arc(sparkleX, sparkleY, 2 + sparkleSize * 3, 0, Math.PI * 2);
              ctx.fill();
            }
            
            ctx.fillStyle = `rgba(255, 255, 255, ${sparkleIntensity * 0.7})`;
            ctx.fillRect(a.x + a.w*0.35, a.y + bounce + a.h*0.35, a.w*0.3, a.h*0.3);
          }
          
          ctx.restore();
        }
      }
    }
    
    function draw() {
      drawBg();
      drawAcorns();
      drawMoose();
    }

    // Game update
    function update() {
      let onPlatform = false;
      let platformY = null;
      let currentPlatform = null;
      for (let p of platforms) {
        if (
          moose.x + MOOSE_W*0.8 > p.x + 20 && moose.x + MOOSE_W*0.2 < p.x + (p.width || platformWidth) - 20 &&
          moose.y + MOOSE_H >= p.y && moose.y + MOOSE_H <= p.y + 80
        ) {
          onPlatform = true;
          platformY = p.y;
          currentPlatform = p;
          break;
        }
      }
      
      for (let p of platforms) {
        if (currentPlatform === p) {
          p.timeOnPlatform += 1;
          if (p.timeOnPlatform > 180) {
            p.willDestroy = true;
            p.isShaking = true;
          }
          if (p.timeOnPlatform > 300) {
            let index = platforms.indexOf(p);
            if (index > -1) {
              platforms.splice(index, 1);
              console.log('Platform destroyed!');
            }
          }
        }
      }
      
      moose.onPlatform = onPlatform;
      
      if (moose.onPlatform && !moose.justJumped) {
        moose.vy = 0;
        if (platformY !== null) {
          moose.y = platformY - MOOSE_H + 80;
        }
      } else {
        moose.vy += GRAVITY;
        moose.y += moose.vy;
        if (moose.vy > 0) {
          moose.justJumped = false;
        }
      }
      
      const ACCEL = 0.8;
      const MAX_VX = 5;
      const FRICTION = 0.92;
      if (leftPressed && !rightPressed) {
        moose.ax = -ACCEL;
      } else if (rightPressed && !leftPressed) {
        moose.ax = ACCEL;
      } else {
        moose.ax = 0;
      }
      moose.vx += moose.ax;
      if (moose.vx > MAX_VX) moose.vx = MAX_VX;
      if (moose.vx < -MAX_VX) moose.vx = -MAX_VX;
      if (!leftPressed && !rightPressed) moose.vx *= FRICTION;
      if (Math.abs(moose.vx) < 0.05) moose.vx = 0;
      moose.x += moose.vx;
      if (moose.x < 0) moose.x = 0;
      if (moose.x > W - MOOSE_W) moose.x = W - MOOSE_W;

      // Update falling death acorns
      for (let a of acorns) {
        if (a.falling && a.type === 'death') {
          a.y += a.fallSpeed;
        }
      }

      if (!moose.onPlatform && moose.vy > 0) {
        let lowestPlatformY = Math.max(...platforms.map(p => p.y));
        if (moose.y + MOOSE_H > lowestPlatformY + PLATFORM_HEIGHT) {
          if (!gameOver) {
            gameOver = true;
            gameStarted = false;
            showOverlay(true);
            return;
          }
        }
      }
      
      let seconds = Math.floor((Date.now() - gameStartTime) / 1000);
      let speed = 1.5 + Math.min(1, seconds * 0.02);

      // Camera movement after 5 seconds
      if (seconds > 5) {
        let speedBoosts = Math.floor((seconds - 5) / 10);
        let cameraSpeed = 0.3 + speedBoosts * 0.5;
        
        for (let p of platforms) p.y += cameraSpeed;
        for (let a of acorns) {
          if (!a.falling) a.y += cameraSpeed;
        }
        
        console.log('Camera speed:', cameraSpeed, 'Speed boosts:', speedBoosts);
      }

      // Game over if camera catches moose
      if (moose.y > H - 50) {
        if (!gameOver) {
          console.log('Camera caught the moose - game over!');
          gameOver = true;
          gameStarted = false;
          showOverlay(true);
          return;
        }
      }

      let cameraY = H*0.35;
      while (moose.y < cameraY) {
        let dy = cameraY - moose.y;
        moose.y = cameraY;
        for (let p of platforms) p.y += dy;
        for (let a of acorns) {
          if (!a.falling) a.y += dy;
        }
      }

      // Acorn collection and collision
      for (let a of acorns) {
        if (!a.collected &&
          moose.x + MOOSE_W > a.x && moose.x < a.x + a.w &&
          moose.y + MOOSE_H > a.y && moose.y < a.y + a.h) {
          
          if (a.type === 'death') {
            // Death acorn collision - game over
            if (!gameOver) {
              console.log('Hit by falling death acorn - game over!');
              gameOver = true;
              gameStarted = false;
              showOverlay(true);
              return;
            }
          } else {
            // Normal and gold acorns - collect points
            a.collected = true;
            score += a.points;
            if (score < 0) score = 0;
            
            console.log('Collected', a.type, 'acorn, points:', a.points, 'total:', score);
            scoreSpan.textContent = score;
            if (score > highscore) {
              highscore = score;
              highscoreSpan.textContent = highscore;
              localStorage.setItem('flappy_moose_highscore', highscore);
            }
          }
        }
      }
      
      // Remove old acorns
      acorns = acorns.filter(a => {
        if (a.collected) return false;
        if (a.falling && a.y > H + 100) return false;
        if (!a.falling && a.y < H + a.h) return true;
        return false;
      });

      // Platform generation
      while (platforms.length && (platforms[platforms.length-1].y > -platformGap * 2)) {
        spawnPlatform();
      }
      while (platforms.length && platforms[0].y > H + PLATFORM_HEIGHT) {
        platforms.shift();
      }
      
      let t = Math.floor((Date.now() - gameStartTime) / 1000);
      let wave = 0.5 + 0.5 * Math.sin(t/18);
      platformWidth = Math.max(
        PLATFORM_WIDTH_MIN,
        PLATFORM_WIDTH_START - t*6*wave - score*1.5*wave
      );
      let maxGap = Math.min(getMaxJumpDistance(), PLATFORM_GAP_MAX);
      platformGap = Math.min(
        maxGap,
        PLATFORM_GAP_START + t*3*wave + score*1.2*wave
      );
    }
    
    function getMaxJumpDistance() {
      let vy0 = Math.abs(FLAP);
      let t_flight = 2 * vy0 / GRAVITY;
      let maxSpeed = 5.2;
      return t_flight * maxSpeed * 0.8;
    }
    
    function updateStats() {
      const now = Date.now();
      let sec = Math.floor((now - gameStartTime)/1000);
      let min = Math.floor(sec/60);
      sec = sec%60;
      document.getElementById('statTime').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      document.getElementById('score').textContent = score;
      document.getElementById('highscore').textContent = highscore;
    }
    
    function gameLoop(ts) {
      if (gameStarted && !gameOver) {
        // Spawn platform acorns
        if (!lastAcornTime || ts - lastAcornTime > 1200 + Math.random()*800) {
          spawnAcorn();
          lastAcornTime = ts;
        }
        
        // Spawn acorn clusters less frequently
        if (!window.lastAcornClusterTime || ts - window.lastAcornClusterTime > 4000 + Math.random()*3000) {
          spawnAcornCluster();
          window.lastAcornClusterTime = ts;
        }
        
        // Spawn falling death acorns
        if (!window.lastDeathAcornTime || ts - window.lastDeathAcornTime > 2000 + Math.random()*2000) {
          spawnFallingDeathAcorn();
          window.lastDeathAcornTime = ts;
        }
        
        update();
      }
      draw();
      updateStats();
      requestAnimationFrame(gameLoop);
    }

    // Controls
    function flap() {
      console.log('flap() called, gameStarted:', gameStarted, 'gameOver:', gameOver, 'onPlatform:', moose?.onPlatform);
      if(!gameStarted || gameOver) return;
      moose.vy = FLAP;
      moose.justJumped = true;
      console.log('FLAP! vy set to:', FLAP, 'justJumped:', true);
    }
    let leftPressed = false, rightPressed = false;

    function handleKeyDown(e) {
      console.log('Key pressed:', e.key, e.code, e.keyCode);
      if (
        e.keyCode === 32 ||
        e.code === 'Space' ||
        e.code === 'Spacebar' ||
        e.key === ' ' ||
        e.key === 'ArrowUp'
      ) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Space detected, gameOver:', gameOver, 'gameStarted:', gameStarted);
        if (gameOver) {
          startBtn.click();
        } else if (gameStarted) {
          flap();
        }
        return false;
      }
      if (e.code === 'ArrowLeft' || e.key === 'ArrowLeft') {
        leftPressed = true;
        if (gameStarted && !gameOver) moose.vx = -6;
      }
      if (e.code === 'ArrowRight' || e.key === 'ArrowRight') {
        rightPressed = true;
        if (gameStarted && !gameOver) moose.vx = 6;
      }
    }

    document.addEventListener('keydown', handleKeyDown, true);
    window.addEventListener('keydown', handleKeyDown, true);
    document.body.addEventListener('keydown', handleKeyDown, true);

    document.addEventListener('keyup', function(e) {
      if (e.code === 'ArrowLeft' || e.key === 'ArrowLeft') {
        leftPressed = false;
        if (rightPressed && gameStarted && !gameOver) {
          moose.vx = 6;
        } else if (gameStarted && !gameOver) {
          moose.vx = 0;
        }
      }
      if (e.code === 'ArrowRight' || e.key === 'ArrowRight') {
        rightPressed = false;
        if (leftPressed && gameStarted && !gameOver) {
          moose.vx = -6;
        } else if (gameStarted && !gameOver) {
          moose.vx = 0;
        }
      }
    });
    
    canvas.addEventListener('mousedown', function(e) {
      e.preventDefault();
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });
    
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });

    // UI handling
    const nicknameInputMain = document.getElementById('nicknameInputMain');
    const nicknameCurrent = document.getElementById('nicknameCurrent');
    const gameOverBlock = document.getElementById('gameOverBlock');
    const gameOverText = document.getElementById('gameOverText');
    const gameOverScore = document.getElementById('gameOverScore');
    nicknameInputMain.value = nickname;
    nicknameCurrent.textContent = nickname || 'Player';
    
    nicknameInputMain.addEventListener('input', function() {
      nickname = nicknameInputMain.value.trim();
      nicknameCurrent.textContent = nickname || 'Player';
    });
    
    nicknameInputMain.addEventListener('keydown', function(e) {
      if (
        e.keyCode === 32 ||
        e.code === 'Space' ||
        e.code === 'Spacebar' ||
        e.key === ' ' ||
        e.key === 'ArrowUp'
      ) {
        e.preventDefault();
        if (gameOver) {
          startBtn.click();
        } else if (gameStarted) {
          flap();
        }
      }
    });

    function showOverlay(isGameOver) {
      overlay.style.display = '';
      if (isGameOver) {
        gameOverBlock.style.display = '';
        gameOverText.innerHTML = 'Game over!';
        gameOverScore.innerHTML = `Score: <b style="color:gold">${score}</b><br>Player: <b>${nickname || 'Player'}</b>`;
        startBtn.textContent = 'Restart';
        document.getElementById('gameDesc').style.display = 'none';
      } else {
        gameOverBlock.style.display = 'none';
        startBtn.textContent = 'Start';
        document.getElementById('gameDesc').style.display = '';
      }
    }
    
    function hideOverlay() {
      overlay.style.display = 'none';
    }

    startBtn.onclick = () => {
      nickname = nicknameInputMain.value.trim();
      if (!nickname) {
        nicknameInputMain.style.background = '#ffe0e0';
        return;
      }
      nicknameInputMain.style.background = '';
      nicknameInputMain.value = nickname;
      nicknameCurrent.textContent = nickname || 'Player';
      highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
      resetGame();
      hideOverlay();
      gameStarted = true;
      gameOver = false;
      lastAcornTime = 0;
      window.lastAcornClusterTime = 0;
      window.lastDeathAcornTime = 0;
      gameStartTime = Date.now();
      document.activeElement.blur();
      document.body.focus();
    };

    resetGame();
    showOverlay(false);
    requestAnimationFrame(gameLoop);

    window.addEventListener('resize', () => {
      if(!gameStarted) draw();
    });
  </script>
</body>
</html>
