<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Moose: Acorn Adventure</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: #222;
      font-family: 'Poppins', 'Arial', sans-serif;
      user-select: none;
    }
    #bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
      top: 0; left: 0;
      filter: blur(2px) brightness(0.7);
      pointer-events: none;
    }
    #gameCanvas {
      position: fixed;
      left: 0; top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      background: transparent;
      display: block;
    }
    #scoreBox {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      background: rgba(255,255,255,0.85);
      color: #222;
      border-radius: 22px;
      padding: 14px 38px;
      font-size: 2rem;
      font-weight: bold;
      box-shadow: 0 2px 32px #0005;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #scoreBox img { width: 38px; height: 38px; }
    #highscoreBox {
      position: fixed;
      top: 28px;
      right: 38px;
      z-index: 2;
      color: #fff;
      font-size: 1rem;
      background: rgba(0,0,0,0.4);
      border-radius: 14px;
      padding: 7px 16px;
      box-shadow: 0 2px 8px #0005;
    }
    #overlay {
      position: fixed;
      z-index: 10;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 28px;
      /* –î–æ–¥–∞—î–º–æ —Ñ–æ–Ω —á–µ—Ä–µ–∑ –ø—Å–µ–≤–¥–æ–µ–ª–µ–º–µ–Ω—Ç */
    }
    #overlay::before {
      content: '';
      position: absolute;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.62);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    #gameTitle {
      color: #fff;
      font-size: 3.2rem;
      font-weight: 900;
      text-shadow: 0 4px 32px #000b, 0 2px 0 #fff3;
      letter-spacing: 3px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: center;
      animation: bounce 1s infinite alternate;
      user-select: none;
    }
    #gameTitle .emoji {
      font-size: 2.5rem;
      filter: drop-shadow(0 2px 8px #0008);
    }
    #nicknameBlock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
    }
    #nicknameInputMain {
      font-size: 1.25rem;
      padding: 12px 20px;
      border-radius: 12px;
      border: 1.5px solid #bbb;
      outline: none;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 2px 12px #0002;
      background: rgba(255,255,255,0.92);
      transition: border .18s, box-shadow .18s;
    }
    #nicknameInputMain:focus {
      border: 1.5px solid #2a7b3f;
      box-shadow: 0 2px 18px #2a7b3f33;
    }
    #nicknameCurrent {
      font-size: 1.05rem;
      color: #2a7b3f;
      margin-top: -2px;
      margin-bottom: 2px;
    }
    #startBtn {
      padding: 16px 48px;
      font-size: 1.35rem;
      font-weight: bold;
      border: none;
      border-radius: 18px;
      background: linear-gradient(90deg, #ffe55a 0%, gold 100%);
      color: #333;
      cursor: pointer;
      box-shadow: 0 4px 24px #0007;
      transition: background .18s, transform .12s;
      margin-top: 18px;
      margin-bottom: 10px;
    }
    #startBtn:hover { background: #fff36a; transform: scale(1.045); }
    #gameDesc {
      color: #fff;
      font-size: 1.25rem;
      text-align: center;
      margin-top: 10px;
      line-height: 1.6;
      max-width: 420px;
      text-shadow: 0 2px 12px #000a;
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 12px 18px 10px 18px;
      user-select: none;
    }
    @keyframes bounce { to { transform: translateY(-12px); } }
    #overlayText {
      color: #fff;
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 6px;
      line-height: 1.5;
    }
    #nicknameBlock label {
      color: #fff;
      font-weight: bold;
      font-size: 1.15rem;
      margin-bottom: 2px;
    }
  </style>
</head>
<body tabindex="0" style="margin:0;padding:0;">
  <!-- –í—ñ–¥–µ–æ-—Ñ–æ–Ω –¥–ª—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –µ–∫—Ä–∞–Ω—É -->
  <video id="startBgVideo" src="background.mp4" autoplay loop muted playsinline style="position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;display:block;"></video>
  <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100vw;height:100vh;">
    <canvas id="gameCanvas"></canvas>
    <div id="scoreBox" style="display:none;align-items:center;gap:18px;">
      <span id="statTime">00:00</span>
      <span style="margin: 0 12px;">|</span>
      <img id="acornIcon" src="acorns.webp" alt="acorn" style="width:32px;height:32px;vertical-align:middle;">
      <span id="score">0</span>
      <span style="margin: 0 12px;">|</span>
      <span>Record: <span id="highscore">0</span></span>
    </div>
    <div id="overlay">
      <div id="gameTitle"><span class="emoji">ü¶å</span> Flappy Moose: Stump Dodge <span class="emoji">üå≤</span></div>
      <div id="gameOverBlock" style="display:none;text-align:center;color:#fff;margin-bottom:10px;">
        <div id="gameOverText" style="font-size:1.5rem;font-weight:bold;"></div>
        <div id="gameOverScore" style="font-size:1.2rem;margin:8px 0 0 0;"></div>
      </div>
      <label for="nicknameInputMain" style="font-weight:bold;font-size:1.1rem;margin-top:18px;color:#fff;">Nickname:</label>
      <input id="nicknameInputMain" type="text" maxlength="16" placeholder="Enter your nickname" style="font-size:1.1rem;padding:10px 18px;border-radius:10px;border:1.5px solid #bbb;outline:none;width:100%;max-width:260px;margin-top:6px;">
      <div id="nicknameCurrent" style="font-size:1.05rem;color:#2a7b3f;margin-bottom:2px;">Current: Player</div>
      <button id="startBtn">Start</button>
      <div id="gameDesc">
        Jump on stumps, collect acorns, avoid falling!<br>
        <b>How long can you survive?</b><br>
        <span style="font-size:1.05rem;color:#ffe55a;">The speed increases every second!</span>
      </div>
    </div>
  </div>
  <script>
    // Coursera assignment: Physics fix & robust spacebar jump
    // 1. Moose always lands on platform (vy=0, y snap)
    // 2. Spacebar jump works in all browsers (body focusable, window keydown, e.code support)
    // ========== SETTINGS ==========
    const MOOSE_W = 90, MOOSE_H = 90; // –∑–±—ñ–ª—å—à–µ–Ω–æ –ª–æ—Å—è
    const GRAVITY = 0.09; // —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∞ –≥—Ä–∞–≤—ñ—Ç–∞—Ü—ñ—è –¥–ª—è –±—ñ–ª—å—à–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
    const FLAP = -7; // —Å–∏–ª—å–Ω—ñ—à–∏–π —Å—Ç—Ä–∏–±–æ–∫
    const PIPE_W = 60, PIPE_GAP = 380;
    const PIPE_SPEED = 2.2;
    let gameStarted = false, gameOver = false;
    let score = 0;
    let highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
    let nickname = '';
    let moose = null, pipes = [], acorns = [], animId = 0, lastPipeTime = 0;
    let W=window.innerWidth, H=window.innerHeight;
    let clouds = [];
    let lastAcornTime = 0;
    let platformOffset = 0;
    const RUN_SPEED = 3.2;
    const PLATFORM_HEIGHT = 180; // —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–≥–ª—è–¥—É
    let mooseStep = 0;
    const PLATFORM_TOP_OFFSET = 70// —Å–∫—ñ–ª—å–∫–∏ –ø—ñ–∫—Å–µ–ª—ñ–≤ –≤—ñ–¥ –≤–µ—Ä—Ö—É –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–æ —Ç—Ä–∞–≤–∏
    let gameStartTime = 0;

    // –î–æ–¥–∞—é –º–∞—Å–∏–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º
    let platforms = [];
    const PLATFORM_MIN_Y = 120;
    const PLATFORM_MAX_Y = 320;
    // –ó–∞–º—ñ—Å—Ç—å const PLATFORM_WIDTH —ñ PLATFORM_GAP ‚Äî let, —â–æ–± –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø—ñ–¥ —á–∞—Å –≥—Ä–∏
    let platformWidth = 600;
    let platformGap = 200;
    const PLATFORM_WIDTH_START = 600;
    const PLATFORM_WIDTH_MIN = 260;
    const PLATFORM_GAP_START = 200;
    const PLATFORM_GAP_MAX = 420;

    // ========== LOAD IMAGES ==========
    const mooseImg = new Image();
    mooseImg.src = "moose.webp";
    const acornImg = new Image();
    acornImg.src = "acorns.webp";
    const platformImg = new Image();
    platformImg.src = "platform.webp";
    const bgImg = new Image();
    bgImg.src = "background.webp";
    // –î–æ–¥–∞—é —â–µ –æ–¥–∏–Ω Image –¥–ª—è –ø–∞—Ä–∞–ª–∞–∫—Å-—Ñ–æ–Ω—É
    const parallaxBgImg = new Image();
    parallaxBgImg.src = "background.webp";

    // ========== DOM ==========
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreBox = document.getElementById('scoreBox');
    const scoreSpan = document.getElementById('score');
    const highscoreBox = document.getElementById('highscoreBox');
    const highscoreSpan = document.getElementById('highscore');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const overlayText = document.getElementById('overlayText');
    const nicknameInput = document.getElementById('nicknameInput');
    const startBgVideo = document.getElementById('startBgVideo');
    const smallInstruction = document.getElementById('smallInstruction');
    function resize() {
      W = window.innerWidth; H = window.innerHeight;
      canvas.width = W; canvas.height = H;
    }
    window.addEventListener('resize', resize);
    resize();

    // ========== GAME OBJECTS ==========
    function resetGame() {
      moose = {
        x: W*0.15,
        y: 0, // –±—É–¥–µ –≤–∏—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        vy: 0,
        alive: true
      };
      acorns = [];
      clouds = [];
      platformOffset = 0;
      mooseStep = 0;
      platforms = [];
      // –°–∫–∏–¥–∞—î–º–æ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
      platformWidth = PLATFORM_WIDTH_START;
      platformGap = PLATFORM_GAP_START;
      // –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞—Ä—Ç–æ–≤—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏
      let px = 0;
      for (let i = 0; px < W + 2*platformWidth; i++) {
        let py = i % 2 === 0 ? H-PLATFORM_HEIGHT+PLATFORM_TOP_OFFSET : H-PLATFORM_HEIGHT+PLATFORM_TOP_OFFSET-100-Math.random()*100;
        platforms.push({x: px, y: py});
        px += platformWidth + platformGap;
      }
      // –°—Ç–∞–≤–∏–º–æ –ª–æ—Å—è –Ω–∞ –ø–µ—Ä—à—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
      moose.y = platforms[0].y - MOOSE_H + 80;
      score = 0;
      gameOver = false;
      scoreBox.style.display = '';
      // highscoreBox.style.display = '';
      scoreSpan.textContent = score;
      highscoreSpan.textContent = highscore;
    }

    // –î–æ–¥–∞—é spawnPlatform –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º —Å–ø—Ä–∞–≤–∞
    function spawnPlatform() {
      // –û—Å—Ç–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
      const last = platforms[platforms.length-1];
      let px = last.x + (last.width || platformWidth) + platformGap;
      // –í–∏–ø–∞–¥–∫–æ–≤–∞ –≤–∏—Å–æ—Ç–∞ (—á–µ—Ä–≥—É–≤–∞–Ω–Ω—è, —è–∫ —É resetGame)
      let minY = H-PLATFORM_HEIGHT+PLATFORM_TOP_OFFSET-120;
      let maxY = H-PLATFORM_HEIGHT+PLATFORM_TOP_OFFSET;
      let py = minY + Math.random() * (maxY - minY);
      // –í–∏–ø–∞–¥–∫–æ–≤–∞ —à–∏—Ä–∏–Ω–∞ (–∞–ª–µ –Ω–µ –º–µ–Ω—à–µ PLATFORM_WIDTH_MIN)
      let w = Math.max(PLATFORM_WIDTH_MIN, platformWidth * (0.7 + Math.random()*0.5));
      platforms.push({x: px, y: py, width: w});
    }

    // ========== SPAWNERS ==========
    function spawnAcorn() {
      // –í–∏–±–∏—Ä–∞—î–º–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —è–∫–∞ —â–µ –Ω–µ –≤–∏–¥–Ω–∞ –≥—Ä–∞–≤—Ü—é (x > W)
      let candidates = platforms.filter(p => p.x > W);
      if (candidates.length === 0) return;
      let p = candidates[Math.floor(Math.random()*candidates.length)];
      let y = p.y - 60; // –≤–∏—â–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏
      acorns.push({
        x: p.x + 60 + Math.random()*((p.width || platformWidth)-120),
        y: y,
        w: 70, // –∑–±—ñ–ª—å—à–µ–Ω–æ –∂–æ–ª—É–¥—å
        h: 70,
        collected: false
      });
    }

    // ========== DRAW ==========
    function drawBg() {
      // –ü–∞—Ä–∞–ª–∞–∫—Å-—Ñ–æ–Ω (—Ä—É—Ö–∞—î—Ç—å—Å—è –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)
      let t = (Date.now() - gameStartTime) / 1000;
      let parallaxX = -((t*0.5)%1) * W; // –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–∏–π —Ä—É—Ö
      ctx.globalAlpha = 0.7;
      ctx.drawImage(parallaxBgImg, parallaxX, 0, W, H);
      ctx.drawImage(parallaxBgImg, parallaxX+W, 0, W, H); // seamless
      ctx.globalAlpha = 1;
      // –û—Å–Ω–æ–≤–Ω–∏–π —Ñ–æ–Ω
      ctx.drawImage(bgImg, 0, 0, W, H);
      // –ú–∞–ª—é—î–º–æ –≤—Å—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏
      for (let p of platforms) {
        ctx.drawImage(platformImg, p.x, p.y, p.width || platformWidth, PLATFORM_HEIGHT);
      }
      // –•–º–∞—Ä–∫–∏
      for (let c of clouds) {
        ctx.save();
        ctx.globalAlpha = c.opacity;
        ctx.beginPath();
        ctx.ellipse(c.x, c.y, c.w, c.h, 0, 0, 2*Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.restore();
      }
      // –ó–º—ñ–Ω–∞ —á–∞—Å—É –¥–æ–±–∏: –Ω–∞–∫–ª–∞–¥–∞—î–º–æ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —à–∞—Ä
      let dayPhase = 0.5 + 0.5 * Math.sin(t/22); // –≤—ñ–¥ 0 –¥–æ 1
      // –í—ñ–¥ –±–ª–∞–∫–∏—Ç–Ω–æ–≥–æ –¥–æ —Ç–µ–º–Ω–æ-—Å–∏–Ω—å–æ–≥–æ
      let r = Math.round(60 + 40*dayPhase);
      let g = Math.round(120 + 60*dayPhase);
      let b = Math.round(200 + 40*dayPhase);
      ctx.fillStyle = `rgba(${r},${g},${b},0.22)`;
      ctx.fillRect(0,0,W,H);
    }
    function drawMoose() {
      ctx.save();
      ctx.translate(moose.x + MOOSE_W/2, moose.y + MOOSE_H/2);
      // –ü—Ä–∏–±—Ä–∞–Ω–æ –ø–æ—Ö–∏—Ç—É–≤–∞–Ω–Ω—è (–∞–Ω—ñ–º–∞—Ü—ñ—é –±—ñ–≥—É)
      ctx.rotate(Math.max(-0.5, Math.min(0.5, moose.vy/18)));
      ctx.drawImage(mooseImg, -MOOSE_W/2, -MOOSE_H/2, MOOSE_W, MOOSE_H);
      ctx.restore();
    }
    function drawAcorns() {
      for (let a of acorns) {
        if (!a.collected) ctx.drawImage(acornImg, a.x, a.y, a.w, a.h);
      }
    }
    function draw() {
      drawBg();
      drawAcorns();
      drawMoose();
    }

    // ========== GAME LOOP ==========
    function update() {
      // Moose physics
      let onPlatform = false;
      let platformY = null;
      for (let p of platforms) {
        // –°—É–≤–æ—Ä—ñ—à–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ x: —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ "–Ω–æ–≥–∏" –ª–æ—Å—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ
        if (
          moose.x + MOOSE_W*0.8 > p.x + 20 && moose.x + MOOSE_W*0.2 < p.x + (p.width || platformWidth) - 20 &&
          moose.y + MOOSE_H >= p.y && moose.y + MOOSE_H <= p.y + 120 &&
          moose.vy >= 0
        ) {
          onPlatform = true;
          platformY = p.y;
          break;
        }
      }
      if (!onPlatform) {
        moose.y += moose.vy;
        moose.vy += GRAVITY;
      } else {
        moose.vy = 0;
        // –ü–ª–∞–≤–Ω–µ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–Ω—è
        moose.y += (platformY - MOOSE_H + 80 -moose.y) * 0.5;
      }
      // –î–æ–¥–∞—é –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–æ–≥—Ä–∞—à—É
      if (!onPlatform && moose.y > H && !gameOver) {
        gameOver = true;
        gameStarted = false;
        showOverlay(true);
        return;
      }
      // –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å: RUN_SPEED –∑—Ä–æ—Å—Ç–∞—î –∑ —á–∞—Å–æ–º
      let seconds = Math.floor((Date.now() - gameStartTime) / 1000);
      let speed = 3.2 + Math.min(2, seconds * 0.04); // –º–∞–∫—Å–∏–º—É–º +2 –¥–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ
      for (let p of platforms) p.x -= speed;
      for (let a of acorns) {
        a.x -= speed;
        if (!a.collected &&
          moose.x + MOOSE_W > a.x && moose.x < a.x + a.w &&
          moose.y + MOOSE_H > a.y && moose.y < a.y + a.h) {
          a.collected = true;
          score++;
          scoreSpan.textContent = score;
          // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–∫–æ—Ä–¥
          if (score > highscore) {
            highscore = score;
            highscoreSpan.textContent = highscore;
            localStorage.setItem('flappy_moose_highscore', highscore);
          }
        }
      }
      // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –∂–æ–ª—É–¥—ñ
      acorns = acorns.filter(a => a.x > -a.w || !a.collected);

      // ====== –î–æ–¥–∞—é –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—É –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –ø–ª–∞—Ç—Ñ–æ—Ä–º =====
      // –Ø–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø—Ä–∞–≤—ñ—à–µ –µ–∫—Ä–∞–Ω–∞ –º–µ–Ω—à–µ –Ω—ñ–∂ –Ω–∞ 1 –ø–ª–∞—Ç—Ñ–æ—Ä–º—É ‚Äî –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—É
      while (platforms.length && (platforms[platforms.length-1].x < W + (platforms[platforms.length-1].width || platformWidth))) {
        spawnPlatform();
      }
      // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏, —è–∫—ñ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–π—à–ª–∏ –∑–∞ –ª—ñ–≤–∏–π –∫—Ä–∞–π
      while (platforms.length && platforms[0].x < -(platforms[0].width || platformWidth)) {
        platforms.shift();
      }
      // === –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å ===
      // –ó–º–µ–Ω—à—É—î–º–æ —à–∏—Ä–∏–Ω—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ —ñ –∑–±—ñ–ª—å—à—É—î–º–æ gap –∑ —á–∞—Å–æ–º (–∞–±–æ –∑ –æ—á–∫–∞–º–∏)
      let t = Math.floor((Date.now() - gameStartTime) / 1000);
      let wave = 0.5 + 0.5 * Math.sin(t/18); // —Ö–≤–∏–ª—è –≤—ñ–¥ 0 –¥–æ 1
      platformWidth = Math.max(
        PLATFORM_WIDTH_MIN,
        PLATFORM_WIDTH_START - t*6*wave - score*1.5*wave
      );
      // –û–±–º–µ–∂—É—î–º–æ platformGap –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é –¥–æ—Å—è–∂–Ω–æ—é –≤—ñ–¥—Å—Ç–∞–Ω–Ω—é
      let maxGap = Math.min(getMaxJumpDistance(), PLATFORM_GAP_MAX);
      platformGap = Math.min(
        maxGap,
        PLATFORM_GAP_START + t*3*wave + score*1.2*wave
      );
    }
    function getMaxJumpDistance() {
      // t_flight = 2 * |FLAP| / GRAVITY
      // maxDist = t_flight * speed (speed –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —á–∞—Å—É)
      let vy0 = Math.abs(FLAP);
      let t_flight = 2 * vy0 / GRAVITY;
      // –ë–µ—Ä–µ–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 5.2)
      let maxSpeed = 5.2;
      return t_flight * maxSpeed * 0.8; // 80% –≤—ñ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ
    }
    function updateStats() {
      // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å
      const now = Date.now();
      let sec = Math.floor((now - gameStartTime)/1000);
      let min = Math.floor(sec/60);
      sec = sec%60;
      document.getElementById('statTime').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∞—Ö—É–Ω–æ–∫ —ñ highscore (–≤–∂–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö, –∞–ª–µ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ)
      document.getElementById('score').textContent = score;
      document.getElementById('highscore').textContent = highscore;
    }
    function gameLoop(ts) {
      // –ì—Ä–∞ –º–∞–ª—é—î—Ç—å—Å—è –∑–∞–≤–∂–¥–∏, –∞–ª–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–∏—à–µ —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞
      if (gameStarted && !gameOver) {
        // –°–ø–∞–≤–Ω –∂–æ–ª—É–¥—è —Ä–∞–∑ –Ω–∞ 1.2-2.2 —Å–µ–∫—É–Ω–¥–∏
        if (!lastAcornTime || ts - lastAcornTime > 1200 + Math.random()*1000) {
          spawnAcorn();
          lastAcornTime = ts;
        }
        update();
      }
      draw();
      updateStats();
      requestAnimationFrame(gameLoop);
    }

    // ========== CONTROLS ==========
    function flap() {
      if(!gameStarted || gameOver) return;
      // –ú–æ–∂–Ω–∞ —Å—Ç—Ä–∏–±–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –ª–æ—Å—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ
      let onPlatform = false;
      for (let p of platforms) {
        if (
          moose.x + MOOSE_W*0.8 > p.x + 20 && moose.x + MOOSE_W*0.2 < p.x + (p.width || platformWidth) - 20 &&
          moose.y + MOOSE_H >= p.y && moose.y + MOOSE_H <= p.y + 120
        ) {
          onPlatform = true;
          break;
        }
      }
      if (onPlatform) {
        moose.vy = FLAP;
        console.log('FLAP!');
      }
    }
    // –±—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–∞ –æ–±—Ä–æ–±–∫–∞ Space —ñ —Å—Ç—Ä—ñ–ª–∫–∏ –≤–≥–æ—Ä—É
    document.addEventListener('keydown', function(e) {
      console.log('keydown', e.key, e.code, e.keyCode, document.activeElement);
      // keyCode 32 ‚Äî —Ü–µ –ø—Ä–æ–±—ñ–ª; –¥–æ–¥–∞–Ω–æ 'Spacebar' –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
      if (
        e.keyCode === 32 ||
        e.code === 'Space' ||
        e.code === 'Spacebar' ||
        e.key === ' ' ||
        e.key === 'ArrowUp'
      ) {
        e.preventDefault();
        if (gameOver) {
          startBtn.click();
        } else if (gameStarted) {
          flap();
        }
      }
    });
    canvas.addEventListener('mousedown', function(e) {
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });
    canvas.addEventListener('touchstart', function(e) {
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });

    // ========== OVERLAY ==========
    // Nickname sync logic
    const nicknameInputMain = document.getElementById('nicknameInputMain');
    const nicknameCurrent = document.getElementById('nicknameCurrent');
    const gameOverBlock = document.getElementById('gameOverBlock');
    const gameOverText = document.getElementById('gameOverText');
    const gameOverScore = document.getElementById('gameOverScore');
    nicknameInputMain.value = nickname;
    nicknameCurrent.textContent = nickname || 'Player';
    nicknameInputMain.addEventListener('input', function() {
      nickname = nicknameInputMain.value.trim();
      nicknameCurrent.textContent = nickname || 'Player';
    });

    function showOverlay(isGameOver) {
      overlay.style.display = '';
      if (isGameOver) {
        gameOverBlock.style.display = '';
        gameOverText.innerHTML = 'Game over!';
        gameOverScore.innerHTML = `Score: <b style="color:gold">${score}</b><br>Player: <b>${nickname || 'Player'}</b>`;
        startBtn.textContent = 'Restart';
        document.getElementById('gameDesc').style.display = 'none';
      } else {
        gameOverBlock.style.display = 'none';
        startBtn.textContent = 'Start';
        document.getElementById('gameDesc').style.display = '';
      }
    }
    function hideOverlay() {
      overlay.style.display = 'none';
    }

    startBtn.onclick = () => {
      nickname = nicknameInputMain.value.trim();
      if (!nickname) {
        nicknameInputMain.style.background = '#ffe0e0';
        return;
      }
      nicknameInputMain.style.background = '';
      nicknameInputMain.value = nickname;
      nicknameCurrent.textContent = nickname || 'Player';
      highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
      resetGame();
      hideOverlay();
      gameStarted = true;
      gameOver = false;
      lastAcornTime = 0;
      gameStartTime = Date.now();
      document.activeElement.blur();
      document.body.focus();
    };

    resetGame();
    showOverlay(false);
    requestAnimationFrame(gameLoop);

    window.addEventListener('resize', () => {
      if(!gameStarted) draw();
    });

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –∞–Ω—ñ–º–∞—Ü—ñ—ó –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    // requestAnimationFrame(gameLoop); // This line is now handled by the new_code
  </script>
</body>
</html>