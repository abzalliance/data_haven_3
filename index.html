<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Moose: Acorn Adventure</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: #222;
      font-family: 'Poppins', 'Arial', sans-serif;
      user-select: none;
    }
    #bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
      top: 0; left: 0;
      filter: blur(2px) brightness(0.7);
      pointer-events: none;
    }
    #gameCanvas {
      position: fixed;
      left: 0; top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      background: transparent;
      display: block;
    }
    #scoreBox {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      background: rgba(255,255,255,0.85);
      color: #222;
      border-radius: 22px;
      padding: 14px 38px;
      font-size: 2rem;
      font-weight: bold;
      box-shadow: 0 2px 32px #0005;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #scoreBox img { width: 38px; height: 38px; }
    #highscoreBox {
      position: fixed;
      top: 28px;
      right: 38px;
      z-index: 2;
      color: #fff;
      font-size: 1rem;
      background: rgba(0,0,0,0.4);
      border-radius: 14px;
      padding: 7px 16px;
      box-shadow: 0 2px 8px #0005;
    }
    #overlay {
      position: fixed;
      z-index: 10;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 28px;
      /* –î–æ–¥–∞—î–º–æ —Ñ–æ–Ω —á–µ—Ä–µ–∑ –ø—Å–µ–≤–¥–æ–µ–ª–µ–º–µ–Ω—Ç */
    }
    #overlay::before {
      content: '';
      position: absolute;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.62);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    #gameTitle {
      color: #fff;
      font-size: 3.2rem;
      font-weight: 900;
      text-shadow: 0 4px 32px #000b, 0 2px 0 #fff3;
      letter-spacing: 3px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: center;
      animation: bounce 1s infinite alternate;
      user-select: none;
    }
    #gameTitle .emoji {
      font-size: 2.5rem;
      filter: drop-shadow(0 2px 8px #0008);
    }
    #nicknameBlock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
    }
    #nicknameInputMain {
      font-size: 1.25rem;
      padding: 12px 20px;
      border-radius: 12px;
      border: 1.5px solid #bbb;
      outline: none;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 2px 12px #0002;
      background: rgba(255,255,255,0.92);
      transition: border .18s, box-shadow .18s;
    }
    #nicknameInputMain:focus {
      border: 1.5px solid #2a7b3f;
      box-shadow: 0 2px 18px #2a7b3f33;
    }
    #nicknameCurrent {
      font-size: 1.05rem;
      color: #2a7b3f;
      margin-top: -2px;
      margin-bottom: 2px;
    }
    #startBtn {
      padding: 16px 48px;
      font-size: 1.35rem;
      font-weight: bold;
      border: none;
      border-radius: 18px;
      background: linear-gradient(90deg, #ffe55a 0%, gold 100%);
      color: #333;
      cursor: pointer;
      box-shadow: 0 4px 24px #0007;
      transition: background .18s, transform .12s;
      margin-top: 18px;
      margin-bottom: 10px;
    }
    #startBtn:hover { background: #fff36a; transform: scale(1.045); }
    #gameDesc {
      color: #fff;
      font-size: 1.25rem;
      text-align: center;
      margin-top: 10px;
      line-height: 1.6;
      max-width: 420px;
      text-shadow: 0 2px 12px #000a;
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 12px 18px 10px 18px;
      user-select: none;
    }
    @keyframes bounce { to { transform: translateY(-12px); } }
    #overlayText {
      color: #fff;
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 6px;
      line-height: 1.5;
    }
    #nicknameBlock label {
      color: #fff;
      font-weight: bold;
      font-size: 1.15rem;
      margin-bottom: 2px;
    }
  </style>
</head>
<body tabindex="0" style="margin:0;padding:0;">
  <!-- –í—ñ–¥–µ–æ-—Ñ–æ–Ω –¥–ª—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –µ–∫—Ä–∞–Ω—É -->
  <video id="startBgVideo" src="background.mp4" autoplay loop muted playsinline style="position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;display:block;"></video>
  <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100vw;height:100vh;">
    <canvas id="gameCanvas"></canvas>
    <div id="scoreBox" style="display:none;align-items:center;gap:18px;">
      <span id="statTime">00:00</span>
      <span style="margin: 0 12px;">|</span>
      <img id="acornIcon" src="acorns.webp" alt="acorn" style="width:32px;height:32px;vertical-align:middle;">
      <span id="score">0</span>
      <span style="margin: 0 12px;">|</span>
      <span>Record: <span id="highscore">0</span></span>
    </div>
    <div id="overlay">
      <div id="gameTitle"><span class="emoji">ü¶å</span> Flappy Moose: Stump Dodge <span class="emoji">üå≤</span></div>
      <div id="gameOverBlock" style="display:none;text-align:center;color:#fff;margin-bottom:10px;">
        <div id="gameOverText" style="font-size:1.5rem;font-weight:bold;"></div>
        <div id="gameOverScore" style="font-size:1.2rem;margin:8px 0 0 0;"></div>
      </div>
      <label for="nicknameInputMain" style="font-weight:bold;font-size:1.1rem;margin-top:18px;color:#fff;">Nickname:</label>
      <input id="nicknameInputMain" type="text" maxlength="16" placeholder="Enter your nickname" style="font-size:1.1rem;padding:10px 18px;border-radius:10px;border:1.5px solid #bbb;outline:none;width:100%;max-width:260px;margin-top:6px;">
      <div id="nicknameCurrent" style="font-size:1.05rem;color:#2a7b3f;margin-bottom:2px;">Current: Player</div>
      <button id="startBtn">Start</button>
      <div id="gameDesc">
        Jump on stumps, collect acorns, avoid falling!<br>
        <b>How long can you survive?</b><br>
        <span style="font-size:1.05rem;color:#ffe55a;">The speed increases every second!</span>
      </div>
    </div>
  </div>
  <script>
    // Coursera assignment: Physics fix & robust spacebar jump
    // 1. Moose always lands on platform (vy=0, y snap)
    // 2. Spacebar jump works in all browsers (body focusable, window keydown, e.code support)
    // ========== SETTINGS ==========
    const MOOSE_W = 90, MOOSE_H = 90; // –∑–±—ñ–ª—å—à–µ–Ω–æ –ª–æ—Å—è
    const GRAVITY = 0.09; // —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∞ –≥—Ä–∞–≤—ñ—Ç–∞—Ü—ñ—è –¥–ª—è –±—ñ–ª—å—à–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
    const FLAP = -7; // —Å–∏–ª—å–Ω—ñ—à–∏–π —Å—Ç—Ä–∏–±–æ–∫
    const PIPE_W = 60, PIPE_GAP = 380;
    const PIPE_SPEED = 2.2;
    let gameStarted = false, gameOver = false;
    let score = 0;
    let highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
    let nickname = '';
    let moose = null, pipes = [], acorns = [], animId = 0, lastPipeTime = 0;
    let W=window.innerWidth, H=window.innerHeight;
    let clouds = [];
    let lastAcornTime = 0;
    let platformOffset = 0;
    const RUN_SPEED = 3.2;
    const PLATFORM_HEIGHT = 180; // —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–≥–ª—è–¥—É
    let mooseStep = 0;
    const PLATFORM_TOP_OFFSET = 70// —Å–∫—ñ–ª—å–∫–∏ –ø—ñ–∫—Å–µ–ª—ñ–≤ –≤—ñ–¥ –≤–µ—Ä—Ö—É –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–æ —Ç—Ä–∞–≤–∏
    let gameStartTime = 0;

    // –î–æ–¥–∞—é –º–∞—Å–∏–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º
    let platforms = [];
    // –ü—Ä–∏–±–∏—Ä–∞—é obstacles —Ç–∞ clouds
    const PLATFORM_MIN_Y = 120;
    const PLATFORM_MAX_Y = 320;
    // –ó–∞–º—ñ—Å—Ç—å const PLATFORM_WIDTH —ñ PLATFORM_GAP ‚Äî let, —â–æ–± –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø—ñ–¥ —á–∞—Å –≥—Ä–∏
    let platformWidth = 600;
    let platformGap = 200;
    const PLATFORM_WIDTH_START = 600;
    const PLATFORM_WIDTH_MIN = 260;
    const PLATFORM_GAP_START = 200;
    const PLATFORM_GAP_MAX = 420;

    // ========== LOAD IMAGES ==========
    const mooseImg = new Image();
    mooseImg.src = "moose.webp";
    const mooseLeftImg = new Image();
    mooseLeftImg.src = "moose_left.webp";
    const acornImg = new Image();
    acornImg.src = "acorns.webp";
    const platformImg = new Image();
    platformImg.src = "platform.webp";
    const bgImg = new Image();
    bgImg.src = "background.webp";
    // –î–æ–¥–∞—é —â–µ –æ–¥–∏–Ω Image –¥–ª—è –ø–∞—Ä–∞–ª–∞–∫—Å-—Ñ–æ–Ω—É
    const parallaxBgImg = new Image();
    parallaxBgImg.src = "background.webp";

    // ========== DOM ==========
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreBox = document.getElementById('scoreBox');
    const scoreSpan = document.getElementById('score');
    const highscoreBox = document.getElementById('highscoreBox');
    const highscoreSpan = document.getElementById('highscore');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const overlayText = document.getElementById('overlayText');
    const nicknameInput = document.getElementById('nicknameInput');
    const startBgVideo = document.getElementById('startBgVideo');
    const smallInstruction = document.getElementById('smallInstruction');
    function resize() {
      W = window.innerWidth; H = window.innerHeight;
      canvas.width = W; canvas.height = H;
    }
    window.addEventListener('resize', resize);
    resize();

    // ========== GAME OBJECTS ==========
    function resetGame() {
      moose = {
        x: W*0.5 - MOOSE_W/2, // –ø–æ —Ü–µ–Ω—Ç—Ä—É
        y: 0, // —Ç–∏–º—á–∞—Å–æ–≤–æ
        vy: 0,
        vx: 0, // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å
        ax: 0, // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è
        alive: true,
        onPlatform: true, // –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ, —â–æ –ª–æ—Å—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        justJumped: false // –¥–æ–¥–∞—é —Ñ–ª–∞–≥ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Å–∫–∏–¥–∞–Ω–Ω—è vy –ø—ñ—Å–ª—è —Å—Ç—Ä–∏–±–∫–∞
      };
      acorns = [];
      // –ü—Ä–∏–±–∏—Ä–∞—é obstacles —Ç–∞ clouds
      platformOffset = 0;
      mooseStep = 0;
      platforms = [];
      // –°–∫–∏–¥–∞—î–º–æ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
      platformWidth = PLATFORM_WIDTH_START;
      platformGap = PLATFORM_GAP_START;
      // –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞—Ä—Ç–æ–≤—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ (–∑–Ω–∏–∑—É –≤–≥–æ—Ä—É)
      let py = H - PLATFORM_HEIGHT - 40; // –Ω–∞–π–Ω–∏–∂—á–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∞
      // –°—Ç–≤–æ—Ä—é—î–º–æ –±—ñ–ª—å—à–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å
      for (let i = 0; py > -platformGap * 3; i++) { // –∑–±—ñ–ª—å—à–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º
        let px = W*0.5 - platformWidth/2 + (Math.random()-0.5)*W*0.25;
        platforms.push({x: px, y: py, width: platformWidth});
        py -= platformGap;
      }
      // –ù–∞–π–Ω–∏–∂—á–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî –ø–µ—Ä—à–∞ —É –º–∞—Å–∏–≤—ñ
      let lowest = platforms[0];
      moose.y = lowest.y - MOOSE_H + 80; // –ø—Ä–∞–≤–∏–ª—å–Ω–µ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ
      score = 0;
      gameOver = false;
      scoreBox.style.display = '';
      scoreSpan.textContent = score;
      highscoreSpan.textContent = highscore;
    }

    // –î–æ–¥–∞—é spawnPlatform –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º –∑–≤–µ—Ä—Ö—É
    function spawnPlatform() {
      // –û—Å—Ç–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
      const last = platforms[platforms.length-1];
      let py = last.y - platformGap;
      let px = W*0.5 - platformWidth/2 + (Math.random()-0.5)*W*0.4;
      let w = Math.max(PLATFORM_WIDTH_MIN, platformWidth * (0.7 + Math.random()*0.5));
      platforms.push({x: px, y: py, width: w});
    }

    // ========== SPAWNERS ==========
    function spawnAcorn() {
      // –í–∏–±–∏—Ä–∞—î–º–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —è–∫–∞ –ó–ê –ï–ö–†–ê–ù–û–ú (–≤–≥–æ—Ä—ñ), —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —ó—Ö –±–∞—á–∏–≤ –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å
      let candidates = platforms.filter(p => p.y < -50 && p.y > -400);
      if (candidates.length === 0) return;
      let p = candidates[Math.floor(Math.random()*candidates.length)];
      
      // –õ–æ–≥—ñ–∫–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—É –∂–æ–ª—É–¥—ñ–≤
      let acornType = Math.random();
      let type, points, filter, size;
      
      if (acornType < 0.15) {
        // –ß–æ—Ä–Ω—ñ –∂–æ–ª—É–¥—ñ - –∑–Ω—ñ–º–∞—é—Ç—å –æ—á–∫–∏ (15%)
        type = 'death';
        points = -2; // –∑–Ω—ñ–º–∞—é—Ç—å 2 –æ—á–∫–∏
        filter = 'brightness(0.2) contrast(2) sepia(1) hue-rotate(0deg) saturate(0)'; // —á–æ—Ä–Ω–∏–π
        size = 55;
      } else if (acornType < 0.25) {
        // –ó–æ–ª–æ—Ç—ñ –∂–æ–ª—É–¥—ñ - +3 –æ—á–∫–∏ (10%)
        type = 'gold';
        points = 3;
        filter = 'brightness(1.2) contrast(1.1) sepia(1) hue-rotate(45deg) saturate(3)'; // –∑–æ–ª–æ—Ç–∏–π
        size = 70;
      } else {
        // –ó–≤–∏—á–∞–π–Ω—ñ –∂–æ–ª—É–¥—ñ - +1 –æ—á–∫–æ (75%)
        type = 'normal';
        points = 1;
        filter = 'brightness(0.8) contrast(1.1) sepia(0.8) hue-rotate(25deg) saturate(1.5)'; // –∫–æ—Ä–∏—á–Ω–µ–≤–∏–π
        size = 60;
      }
      
      let x = p.x + 80 + Math.random()*((p.width || platformWidth)-160);
      acorns.push({
        x: x,
        y: p.y - 60,
        w: size,
        h: size,
        type: type,
        points: points,
        filter: filter,
        collected: false,
        sparkle: type === 'gold' ? 0 : null // –∞–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –∑–æ–ª–æ—Ç–∏—Ö
      });
      
      console.log('Created', type, 'acorn at:', x, p.y - 60);
    }

    // –î–æ–¥–∞—é —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä—É–ø–∏ –∂–æ–ª—É–¥—ñ–≤
    function spawnAcornCluster() {
      // –í–∏–±–∏—Ä–∞—î–º–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ó–ê –ï–ö–†–ê–ù–û–ú
      let candidates = platforms.filter(p => p.y < -100 && p.y > -350);
      if (candidates.length === 0) return;
      let p = candidates[Math.floor(Math.random()*candidates.length)];
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ 2-4 –∂–æ–ª—É–¥—ñ –Ω–∞ –æ–¥–Ω—ñ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ
      let numAcorns = 2 + Math.floor(Math.random() * 3);
      for (let i = 0; i < numAcorns; i++) {
        let x = p.x + 100 + i * 80 + Math.random() * 40;
        if (x > p.x + (p.width || platformWidth) - 100) break;
        
        let acornType = Math.random();
        let type, points, filter, size;
        
        if (acornType < 0.08) {
          // –ú–µ–Ω—à–µ —á–æ—Ä–Ω–∏—Ö —É –∫–ª–∞—Å—Ç–µ—Ä—ñ (8%)
          type = 'death';
          points = -2; // –∑–Ω—ñ–º–∞—é—Ç—å 2 –æ—á–∫–∏
          filter = 'brightness(0.2) contrast(2) sepia(1) hue-rotate(0deg) saturate(0)'; // —á–æ—Ä–Ω–∏–π
          size = 55;
        } else if (acornType < 0.18) {
          // –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –∑–æ–ª–æ—Ç–∏—Ö —É –∫–ª–∞—Å—Ç–µ—Ä—ñ (10%)
          type = 'gold';
          points = 3;
          filter = 'brightness(1.2) contrast(1.1) sepia(1) hue-rotate(45deg) saturate(3)'; // –∑–æ–ª–æ—Ç–∏–π
          size = 70;
        } else {
          // –ó–≤–∏—á–∞–π–Ω—ñ (82%)
          type = 'normal';
          points = 1;
          filter = 'brightness(0.8) contrast(1.1) sepia(0.8) hue-rotate(25deg) saturate(1.5)'; // –∫–æ—Ä–∏—á–Ω–µ–≤–∏–π
          size = 60;
        }
        
        acorns.push({
          x: x,
          y: p.y - 60,
          w: size,
          h: size,
          type: type,
          points: points,
          filter: filter,
          collected: false,
          sparkle: type === 'gold' ? Math.random() * Math.PI * 2 : null
        });
      }
      console.log('Created acorn cluster with', numAcorns, 'acorns');
    }

    // ========== DRAW ==========
    function drawBg() {
      // –ü–∞—Ä–∞–ª–∞–∫—Å-—Ñ–æ–Ω (—Ä—É—Ö–∞—î—Ç—å—Å—è –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)
      let t = (Date.now() - gameStartTime) / 1000;
      let parallaxX = -((t*0.5)%1) * W; // –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–∏–π —Ä—É—Ö
      ctx.globalAlpha = 0.7;
      ctx.drawImage(parallaxBgImg, parallaxX, 0, W, H);
      ctx.drawImage(parallaxBgImg, parallaxX+W, 0, W, H); // seamless
      ctx.globalAlpha = 1;
      // –û—Å–Ω–æ–≤–Ω–∏–π —Ñ–æ–Ω
      ctx.drawImage(bgImg, 0, 0, W, H);
      // –ú–∞–ª—é—î–º–æ –≤—Å—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏
      for (let p of platforms) {
        ctx.drawImage(platformImg, p.x, p.y, p.width || platformWidth, PLATFORM_HEIGHT);
      }
      // –ó–º—ñ–Ω–∞ —á–∞—Å—É –¥–æ–±–∏: –Ω–∞–∫–ª–∞–¥–∞—î–º–æ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —à–∞—Ä
      let dayPhase = 0.5 + 0.5 * Math.sin(t/22); // –≤—ñ–¥ 0 –¥–æ 1
      // –í—ñ–¥ –±–ª–∞–∫–∏—Ç–Ω–æ–≥–æ –¥–æ —Ç–µ–º–Ω–æ-—Å–∏–Ω—å–æ–≥–æ
      let r = Math.round(60 + 40*dayPhase);
      let g = Math.round(120 + 60*dayPhase);
      let b = Math.round(200 + 40*dayPhase);
      ctx.fillStyle = `rgba(${r},${g},${b},0.22)`;
      ctx.fillRect(0,0,W,H);
    }

    function drawMoose() {
      ctx.save();
      ctx.translate(moose.x + MOOSE_W/2, moose.y + MOOSE_H/2);
      // –ü–ª–∞–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
      let targetRotation = Math.max(-0.5, Math.min(0.5, moose.vy/18));
      ctx.rotate(targetRotation);
      // –í–∏–±—ñ—Ä —Å–ø—Ä–∞–π—Ç–∞ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞–ø—Ä—è–º–∫—É
      let img = mooseImg;
      if (moose.vx < -0.5) img = mooseLeftImg;
      ctx.drawImage(img, -MOOSE_W/2, -MOOSE_H/2, MOOSE_W, MOOSE_H);
      ctx.restore();
    }
    function drawAcorns() {
      for (let a of acorns) {
        if (!a.collected) {
          let t = Date.now() / 1000;
          let bounce = Math.sin(t * 3 + a.x * 0.01) * 3;
          
          ctx.save();
          
          if (a.type === 'gold') {
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –±–ª–∏—Å–∫—É –¥–ª—è –∑–æ–ª–æ—Ç–∏—Ö –∂–æ–ª—É–¥—ñ–≤
            a.sparkle += 0.1;
            let sparkleIntensity = (Math.sin(a.sparkle) + 1) / 2;
            
            // –ó–æ–≤–Ω—ñ—à–Ω—î —Å–≤—ñ—á–µ–Ω–Ω—è
            ctx.shadowColor = '#FFD700';
            ctx.shadowBlur = 15 + sparkleIntensity * 10;
          } else if (a.type === 'death') {
            // –¢–µ–º–Ω–µ —Å–≤—ñ—á–µ–Ω–Ω—è –¥–ª—è —á–æ—Ä–Ω–∏—Ö (–ø—Ä–∏–±–∏—Ä–∞—é —á–µ—Ä–≤–æ–Ω–µ)
            ctx.shadowColor = '#000000';
            ctx.shadowBlur = 5;
          }
          
          // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä —á–µ—Ä–µ–∑ CSS filter
          ctx.filter = a.filter;
          
          // –ú–∞–ª—é—î–º–æ –∂–æ–ª—É–¥—å (acornImg –∑–∞–º—ñ—Å—Ç—å mooseImg)
          ctx.drawImage(acornImg, a.x, a.y + bounce, a.w, a.h);
          
          // –°–∫–∏–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä
          ctx.filter = 'none';
          ctx.shadowBlur = 0;
          
          // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏ –¥–ª—è –∑–æ–ª–æ—Ç–∏—Ö –∂–æ–ª—É–¥—ñ–≤
          if (a.type === 'gold') {
            let sparkleIntensity = (Math.sin(a.sparkle) + 1) / 2;
            // –ë–ª–∏—Å–∫
            ctx.fillStyle = `rgba(255, 255, 255, ${sparkleIntensity * 0.6})`;
            ctx.fillRect(a.x + a.w*0.3, a.y + bounce + a.h*0.3, a.w*0.4, a.h*0.4);
          }
          
          ctx.restore();
        }
      }
    }
    function draw() {
      drawBg();
      drawAcorns();
      drawMoose();
    }

    // ========== GAME LOOP ==========
    function update() {
      // Moose physics
      let onPlatform = false;
      let platformY = null;
      for (let p of platforms) {
        // –í–ò–ü–†–ê–í–õ–ï–ù–ê –õ–û–ì–Ü–ö–ê: –¥–æ–∑–≤–æ–ª—è—î–º–æ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–Ω—è –∑–≤–µ—Ä—Ö—É –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ vy
        if (
          moose.x + MOOSE_W*0.8 > p.x + 20 && moose.x + MOOSE_W*0.2 < p.x + (p.width || platformWidth) - 20 &&
          moose.y + MOOSE_H >= p.y && moose.y + MOOSE_H <= p.y + 80 // –ø—Ä–∏–±—Ä–∞–≤ —É–º–æ–≤—É moose.vy >= 0
        ) {
          onPlatform = true;
          platformY = p.y;
          break;
        }
      }
      moose.onPlatform = onPlatform;
      // === –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞ —Ñ—ñ–∑–∏–∫–∞ ===
      if (moose.onPlatform && !moose.justJumped) {
        moose.vy = 0;
        if (platformY !== null) {
          moose.y = platformY - MOOSE_H + 80; // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ –ø–æ—á–∞—Ç–∫–æ–≤–æ—é –ø–æ–∑–∏—Ü—ñ—î—é
        }
      } else {
        moose.vy += GRAVITY;
        moose.y += moose.vy;
        // –°–∫–∏–¥–∞—î–º–æ —Ñ–ª–∞–≥ —Å—Ç—Ä–∏–±–∫–∞, —è–∫—â–æ –ª–æ—Å—å –ø–æ—á–∞–≤ –ø–∞–¥–∞—Ç–∏
        if (moose.vy > 0) {
          moose.justJumped = false;
        }
      }
      // --- –ü–ª–∞–≤–Ω–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π —Ä—É—Ö ---
      const ACCEL = 0.8; // –∑–º–µ–Ω—à–µ–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
      const MAX_VX = 5; // –∑–º–µ–Ω—à–µ–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
      const FRICTION = 0.92; // –∑–±—ñ–ª—å—à–µ–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
      if (leftPressed && !rightPressed) {
        moose.ax = -ACCEL;
      } else if (rightPressed && !leftPressed) {
        moose.ax = ACCEL;
      } else {
        moose.ax = 0;
      }
      moose.vx += moose.ax;
      // –û–±–º–µ–∂–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —à–≤–∏–¥–∫–æ—Å—Ç—ñ
      if (moose.vx > MAX_VX) moose.vx = MAX_VX;
      if (moose.vx < -MAX_VX) moose.vx = -MAX_VX;
      // –¢–µ—Ä—Ç—è, —è–∫—â–æ –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ —Å—Ç—Ä—ñ–ª–∫–∏
      if (!leftPressed && !rightPressed) moose.vx *= FRICTION;
      // –î—É–∂–µ –º–∞–ª–µ–Ω—å–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –æ–±–Ω—É–ª—è—î–º–æ
      if (Math.abs(moose.vx) < 0.05) moose.vx = 0; // –∑–º–µ–Ω—à–µ–Ω–æ –ø–æ—Ä—ñ–≥
      moose.x += moose.vx;
      // –û–±–º–µ–∂–µ–Ω–Ω—è –ø–æ –∫—Ä–∞—è—Ö –µ–∫—Ä–∞–Ω—É
      if (moose.x < 0) moose.x = 0;
      if (moose.x > W - MOOSE_W) moose.x = W - MOOSE_W;

      // –î–æ–¥–∞—é –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–æ–≥—Ä–∞—à—É, —è–∫—â–æ –ª–æ—Å—å –Ω–µ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ —ñ –≤–ø–∞–≤ –Ω–∏–∂—á–µ –≤—Å—ñ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
      if (!moose.onPlatform && moose.vy > 0) {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–Ω–∏–∂—á—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        let lowestPlatformY = Math.max(...platforms.map(p => p.y));
        if (moose.y + MOOSE_H > lowestPlatformY + PLATFORM_HEIGHT) {
          if (!gameOver) {
            gameOver = true;
            gameStarted = false;
            showOverlay(true);
            return;
          }
        }
      }
      // –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å: RUN_SPEED –∑—Ä–æ—Å—Ç–∞—î –∑ —á–∞—Å–æ–º
      let seconds = Math.floor((Date.now() - gameStartTime) / 1000);
      let speed = 1.5 + Math.min(1, seconds * 0.02); // –º–∞–∫—Å–∏–º—É–º +1 –¥–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ

      // ====== –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä—É—Ö –∫–∞–º–µ—Ä–∏ –≤–≥–æ—Ä—É –ø—ñ—Å–ª—è 5 —Å–µ–∫—É–Ω–¥ ======
      if (seconds > 5) {
        // –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏ –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
        let speedBoosts = Math.floor((seconds - 5) / 10); // –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥ +1 boost
        let cameraSpeed = 0.3 + speedBoosts * 0.5; // –∫–æ–∂–µ–Ω boost –¥–æ–¥–∞—î 0.5 –¥–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ
        
        // –†—É—Ö–∞—î–º–æ –≤—Å—ñ –æ–±'—î–∫—Ç–∏ –≤–Ω–∏–∑ (–∫–∞–º–µ—Ä–∞ –≤–≥–æ—Ä—É)
        for (let p of platforms) p.y += cameraSpeed;
        for (let a of acorns) a.y += cameraSpeed;
        
        console.log('Camera speed:', cameraSpeed, 'Speed boosts:', speedBoosts);
      }

      // ====== –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –∫–∞–º–µ—Ä–∞ "–∑'—ó–ª–∞" –ª–æ—Å—è ======
      if (moose.y > H - 50) { // —è–∫—â–æ –ª–æ—Å—å –º–∞–π–∂–µ –Ω–∞ –¥–Ω—ñ –µ–∫—Ä–∞–Ω–∞
        if (!gameOver) {
          console.log('Camera caught the moose - game over!');
          gameOver = true;
          gameStarted = false;
          showOverlay(true);
          return;
        }
      }

      // ====== –ö–∞–º–µ—Ä–∞: —è–∫—â–æ –ª–æ—Å—å –ø—ñ–¥–Ω—è–≤—Å—è –≤–∏—â–µ –ø–µ–≤–Ω–æ—ó –º–µ–∂—ñ, —Ä—É—Ö–∞—î–º–æ –≤—Å—ñ –æ–±'—î–∫—Ç–∏ –≤–Ω–∏–∑ =====
      let cameraY = H*0.35;
      while (moose.y < cameraY) {
        let dy = cameraY - moose.y;
        moose.y = cameraY;
        for (let p of platforms) p.y += dy;
        for (let a of acorns) a.y += dy;
        // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —Ä—É—Ö —Ö–º–∞—Ä, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–±–æ—Ä—É –∂–æ–ª—É–¥—ñ–≤
      for (let a of acorns) {
        if (!a.collected &&
          moose.x + MOOSE_W > a.x && moose.x < a.x + a.w &&
          moose.y + MOOSE_H > a.y && moose.y < a.y + a.h) {
          a.collected = true;
          
          // –í—Å—ñ –∂–æ–ª—É–¥—ñ –¥–∞—é—Ç—å/–∑–Ω—ñ–º–∞—é—Ç—å –æ—á–∫–∏
          score += a.points;
          // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –≤—ñ–¥'—î–º–Ω–æ–º—É —Ä–∞—Ö—É–Ω–∫—É
          if (score < 0) score = 0;
          
          console.log('Collected', a.type, 'acorn, points:', a.points, 'total:', score);
          scoreSpan.textContent = score;
          if (score > highscore) {
            highscore = score;
            highscoreSpan.textContent = highscore;
            localStorage.setItem('flappy_moose_highscore', highscore);
          }
        }
      }
      // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –∂–æ–ª—É–¥—ñ
      acorns = acorns.filter(a => a.y < H + a.h && !a.collected);

      // ====== –î–æ–¥–∞—é –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—É –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –ø–ª–∞—Ç—Ñ–æ—Ä–º =====
      // –Ø–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–∏—â–µ –µ–∫—Ä–∞–Ω–∞ –º–µ–Ω—à–µ –Ω—ñ–∂ –Ω–∞ 2 platformGap ‚Äî –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—É
      while (platforms.length && (platforms[platforms.length-1].y > -platformGap * 2)) {
        spawnPlatform();
      }
      // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏, —è–∫—ñ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–π—à–ª–∏ –∑–∞ –Ω–∏–∑
      while (platforms.length && platforms[0].y > H + PLATFORM_HEIGHT) {
        platforms.shift();
      }
      // === –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å ===
      let t = Math.floor((Date.now() - gameStartTime) / 1000);
      let wave = 0.5 + 0.5 * Math.sin(t/18);
      platformWidth = Math.max(
        PLATFORM_WIDTH_MIN,
        PLATFORM_WIDTH_START - t*6*wave - score*1.5*wave
      );
      let maxGap = Math.min(getMaxJumpDistance(), PLATFORM_GAP_MAX);
      platformGap = Math.min(
        maxGap,
        PLATFORM_GAP_START + t*3*wave + score*1.2*wave
      );
    }
    function getMaxJumpDistance() {
      // t_flight = 2 * |FLAP| / GRAVITY
      // maxDist = t_flight * speed (speed –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —á–∞—Å—É)
      let vy0 = Math.abs(FLAP);
      let t_flight = 2 * vy0 / GRAVITY;
      // –ë–µ—Ä–µ–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É —à–≤–∏–¥–∫—ñ—Å—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 5.2)
      let maxSpeed = 5.2;
      return t_flight * maxSpeed * 0.8; // 80% –≤—ñ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ
    }
    function updateStats() {
      // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å
      const now = Date.now();
      let sec = Math.floor((now - gameStartTime)/1000);
      let min = Math.floor(sec/60);
      sec = sec%60;
      document.getElementById('statTime').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∞—Ö—É–Ω–æ–∫ —ñ highscore (–≤–∂–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö, –∞–ª–µ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ)
      document.getElementById('score').textContent = score;
      document.getElementById('highscore').textContent = highscore;
    }
    function gameLoop(ts) {
      // –ì—Ä–∞ –º–∞–ª—é—î—Ç—å—Å—è –∑–∞–≤–∂–¥–∏, –∞–ª–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–∏—à–µ —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞
      if (gameStarted && !gameOver) {
        // –°–ø–∞–≤–Ω –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∂–æ–ª—É–¥—è —Ä–∞–∑ –Ω–∞ 800-1500–º—Å
        if (!lastAcornTime || ts - lastAcornTime > 800 + Math.random()*700) {
          spawnAcorn();
          lastAcornTime = ts;
        }
        
        // –°–ø–∞–≤–Ω –∫–ª–∞—Å—Ç–µ—Ä–∞ –∂–æ–ª—É–¥—ñ–≤ —Ä–∞–∑ –Ω–∞ 3-5 —Å–µ–∫—É–Ω–¥
        if (!window.lastAcornClusterTime || ts - window.lastAcornClusterTime > 3000 + Math.random()*2000) {
          spawnAcornCluster();
          window.lastAcornClusterTime = ts;
        }
        
        update();
      }
      draw();
      updateStats();
      requestAnimationFrame(gameLoop);
    }

    // ========== CONTROLS ==========
    function flap() {
      console.log('flap() called, gameStarted:', gameStarted, 'gameOver:', gameOver, 'onPlatform:', moose?.onPlatform);
      if(!gameStarted || gameOver) return;
      // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å—Ç—Ä–∏–±–∞—Ç–∏ –∑–∞–≤–∂–¥–∏ (–Ω–µ —Ç—ñ–ª—å–∫–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ)
      moose.vy = FLAP;
      moose.justJumped = true; // –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ñ–ª–∞–≥ —Å—Ç—Ä–∏–±–∫–∞
      console.log('FLAP! vy set to:', FLAP, 'justJumped:', true);
    }
    let leftPressed = false, rightPressed = false;

    // –ü—Ä–∏–±–∏—Ä–∞—é –¥—É–±–ª—ñ–∫–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ —ñ –∑–∞–ª–∏—à–∞—é —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –Ω–∞–¥—ñ–π–Ω–∏–π
    function handleKeyDown(e) {
      console.log('Key pressed:', e.key, e.code, e.keyCode);
      if (
        e.keyCode === 32 ||
        e.code === 'Space' ||
        e.code === 'Spacebar' ||
        e.key === ' ' ||
        e.key === 'ArrowUp'
      ) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Space detected, gameOver:', gameOver, 'gameStarted:', gameStarted);
        if (gameOver) {
          startBtn.click();
        } else if (gameStarted) {
          flap();
        }
        return false;
      }
      if (e.code === 'ArrowLeft' || e.key === 'ArrowLeft') {
        leftPressed = true;
        if (gameStarted && !gameOver) moose.vx = -6;
      }
      if (e.code === 'ArrowRight' || e.key === 'ArrowRight') {
        rightPressed = true;
        if (gameStarted && !gameOver) moose.vx = 6;
      }
    }

    // –î–æ–¥–∞—é –æ–±—Ä–æ–±–Ω–∏–∫–∏ –Ω–∞ —Ä—ñ–∑–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
    document.addEventListener('keydown', handleKeyDown, true);
    window.addEventListener('keydown', handleKeyDown, true);
    document.body.addEventListener('keydown', handleKeyDown, true);

    document.addEventListener('keyup', function(e) {
      if (e.code === 'ArrowLeft' || e.key === 'ArrowLeft') {
        leftPressed = false;
        if (rightPressed && gameStarted && !gameOver) {
          moose.vx = 6;
        } else if (gameStarted && !gameOver) {
          moose.vx = 0;
        }
      }
      if (e.code === 'ArrowRight' || e.key === 'ArrowRight') {
        rightPressed = false;
        if (leftPressed && gameStarted && !gameOver) {
          moose.vx = -6;
        } else if (gameStarted && !gameOver) {
          moose.vx = 0;
        }
      }
    });
    canvas.addEventListener('mousedown', function(e) {
      e.preventDefault();
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      if (gameOver) {
        startBtn.click();
      } else if (gameStarted) {
        flap();
      }
    });

    // ========== OVERLAY ==========
    // Nickname sync logic
    const nicknameInputMain = document.getElementById('nicknameInputMain');
    const nicknameCurrent = document.getElementById('nicknameCurrent');
    const gameOverBlock = document.getElementById('gameOverBlock');
    const gameOverText = document.getElementById('gameOverText');
    const gameOverScore = document.getElementById('gameOverScore');
    nicknameInputMain.value = nickname;
    nicknameCurrent.textContent = nickname || 'Player';
    nicknameInputMain.addEventListener('input', function() {
      nickname = nicknameInputMain.value.trim();
      nicknameCurrent.textContent = nickname || 'Player';
    });
    // –î–æ–¥–∞—é –æ–±—Ä–æ–±–Ω–∏–∫ keydown –¥–ª—è input, —â–æ–± –ø—Ä–æ–±—ñ–ª –ø—Ä–∞—Ü—é–≤–∞–≤ –Ω–∞–≤—ñ—Ç—å —É —Ñ–æ–∫—É—Å—ñ
    nicknameInputMain.addEventListener('keydown', function(e) {
      if (
        e.keyCode === 32 ||
        e.code === 'Space' ||
        e.code === 'Spacebar' ||
        e.key === ' ' ||
        e.key === 'ArrowUp'
      ) {
        e.preventDefault();
        if (gameOver) {
          startBtn.click();
        } else if (gameStarted) {
          flap();
        }
      }
    });

    function showOverlay(isGameOver) {
      overlay.style.display = '';
      if (isGameOver) {
        gameOverBlock.style.display = '';
        gameOverText.innerHTML = 'Game over!';
        gameOverScore.innerHTML = `Score: <b style="color:gold">${score}</b><br>Player: <b>${nickname || 'Player'}</b>`;
        startBtn.textContent = 'Restart';
        document.getElementById('gameDesc').style.display = 'none';
      } else {
        gameOverBlock.style.display = 'none';
        startBtn.textContent = 'Start';
        document.getElementById('gameDesc').style.display = '';
      }
    }
    function hideOverlay() {
      overlay.style.display = 'none';
    }

    startBtn.onclick = () => {
      nickname = nicknameInputMain.value.trim();
      if (!nickname) {
        nicknameInputMain.style.background = '#ffe0e0';
        return;
      }
      nicknameInputMain.style.background = '';
      nicknameInputMain.value = nickname;
      nicknameCurrent.textContent = nickname || 'Player';
      highscore = Number(localStorage.getItem('flappy_moose_highscore')) || 0;
      resetGame();
      hideOverlay();
      gameStarted = true;
      gameOver = false;
      lastAcornTime = 0;
      gameStartTime = Date.now();
      document.activeElement.blur(); // –î–æ–¥–∞—é –∑–Ω—è—Ç—Ç—è —Ñ–æ–∫—É—Å—É –∑ input
      document.body.focus(); // –§–æ–∫—É—Å—É—é body –¥–ª—è –ø—Ä–∏–π–æ–º—É –ø–æ–¥—ñ–π
    };

    resetGame();
    showOverlay(false);
    requestAnimationFrame(gameLoop);

    window.addEventListener('resize', () => {
      if(!gameStarted) draw();
    });

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –∞–Ω—ñ–º–∞—Ü—ñ—ó –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    // requestAnimationFrame(gameLoop); // This line is now handled by the new_code
  </script>
</body>
</html>
